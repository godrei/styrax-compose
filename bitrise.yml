---
format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: android

app:
  envs:
  - ENABLE_PROFILING: '1'
  - PROJECT_LOCATION: "."
  - MODULE: app
  - VARIANT: ''
  - KEYSTORE_KEY_ALIAS: dummy
  - KEYSTORE_KEY_PASSWORD: dummy
  - KEYSTORE_PATH: dummy
  - KEYSTORE_PASSWORD: dummy

workflows:
  _install_custom_cli:
    steps:
    - script@1:
        title: Install custom CLI build
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            go install github.com/bitrise-io/bitrise@4abbcc0b089352714a6372a6fc5d96c6217fb4e7
            cp $GOPATH/bin/bitrise $(which bitrise)
  
  
  # primary workflows for testing nested bitrise run commands
  nesting_level_5:
    run_before:
    - _install_custom_cli
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_5_child_1

  nesting_level_10:
    run_before:
    - _install_custom_cli
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_10_child_1

  # utility workflows for running nested bitrise run commands
  nesting_level_10_child_1:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_10_child_2

  nesting_level_10_child_2:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_10_child_3

  nesting_level_10_child_3:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_10_child_4

  nesting_level_10_child_4:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_10_child_5

  nesting_level_10_child_5:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_10_child_6

  nesting_level_10_child_6:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_10_child_7

  nesting_level_10_child_7:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_10_child_8

  nesting_level_10_child_8:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_10_child_9

  nesting_level_10_child_9:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run android_uitest

  nesting_level_5_child_1:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_5_child_2

  nesting_level_5_child_2:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_5_child_3

  nesting_level_5_child_3:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run nesting_level_5_child_4

  nesting_level_5_child_4:
    steps:
    - script:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            bitrise run android_uitest

  android_uitest:
    steps:
    - install-missing-android-tools:
        inputs:
        - ndk_version: 23.0.7599858
        - gradlew_path: ./gradlew
    - avd-manager@1: {}
    - wait-for-android-emulator@1: {}
    - script@1:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            ./gradlew connectedFreeDebugAndroidTest
            
            sdkmanager --install "system-images;android-29;default;arm64-v8a"
